#!/usr/bin/env node

require('dotenv').config();

// So we can have an absolute path to the base directory at any time
const path	= require('path');
const env	= process.env.NODE_ENV || 'development';
const mysql = require('mysql2');

// Set global variables here. Make sure they start
// with "__"
__basedir	= path.resolve(__dirname, '..');
__dbConfig	= require(`${__basedir}/config/database`)[env];

// Clone the global DB config and add a additional options
// (default is 5)
const configs = {...__dbConfig, connectionLimit: 50, supportBigNumbers: true};
__pool = mysql.createPool(configs);

const app	= require(`${__basedir}/app`);
const debug	= require('debug')('report-server:server');
const http	= require('http');
const models	= require(`${__basedir}/models`);
const { normalizePort, onError, onListening }	= require('./utils');

/**
 * Get port from environment and store in Express.
 */
const port = normalizePort(process.env.PORT || '3001');
app.set('port', port);

/**
 * Create HTTP server.
 */
const server = http.createServer(app);

models.sequelize.sync().then(() => {
	/**
	 * Listen on provided port, on all network interfaces.
	 */
	server.listen(port);
	server.on('error', onError(port));
	server.on('listening', onListening(server, debug));
});

module.exports = server;

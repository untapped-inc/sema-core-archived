#!/usr/bin/env node

require('dotenv').config();

const app = require('../app');
const debug = require('debug')('report-server:server');
const http = require('http');
const path = require('path');
const models = require('../models');
const { normalizePort, onError, onListening } = require('./utils');

// So we can have an absolute path to the base directory at any time
global.__basedir = path.resolve(__dirname, '..');

/**
 * Get port from environment and store in Express.
 */
const port = normalizePort(process.env.PORT || '3001');
app.set('port', port);

/**
 * Create HTTP server.
 */
const server = http.createServer(app);

models.sequelize.sync().then(() => {
	/**
	 * Listen on provided port, on all network interfaces.
	 */
	server.listen(port);
	server.on('error', onError);
	server.on('listening', onListening(server, debug));
});

module.exports = server;
